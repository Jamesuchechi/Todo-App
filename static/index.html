<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ultimate Todo Manager 1.0</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: {
              50: '#f0f9ff', 100: '#e0f2fe', 200: '#bae6fd', 300: '#7dd3fc',
              400: '#38bdf8', 500: '#0ea5e9', 600: '#0284c7', 700: '#0369a1',
              800: '#075985', 900: '#0c4a6e',
            }
          },
          animation: {
            'fade-in': 'fadeIn 0.5s ease-in-out',
            'slide-in': 'slideIn 0.3s ease-out',
            'bounce-in': 'bounceIn 0.6s ease-out',
            'pulse-soft': 'pulseSoft 2s infinite',
            'shake': 'shake 0.5s ease-in-out',
            'timer-pulse': 'timerPulse 1s infinite',
            'float': 'float 3s ease-in-out infinite',
          },
          keyframes: {
            fadeIn: {
              '0%': { opacity: '0' },
              '100%': { opacity: '1' }
            },
            slideIn: {
              '0%': { transform: 'translateY(-10px)', opacity: '0' },
              '100%': { transform: 'translateY(0)', opacity: '1' }
            },
            bounceIn: {
              '0%': { transform: 'scale(0.3)', opacity: '0' },
              '50%': { transform: 'scale(1.05)' },
              '70%': { transform: 'scale(0.9)' },
              '100%': { transform: 'scale(1)', opacity: '1' }
            },
            pulseSoft: {
              '0%, 100%': { opacity: '1' },
              '50%': { opacity: '0.8' }
            },
            shake: {
              '0%, 100%': { transform: 'translateX(0)' },
              '10%, 30%, 50%, 70%, 90%': { transform: 'translateX(-5px)' },
              '20%, 40%, 60%, 80%': { transform: 'translateX(5px)' }
            },
            timerPulse: {
              '0%, 100%': { transform: 'scale(1)', opacity: '1' },
              '50%': { transform: 'scale(1.05)', opacity: '0.9' }
            },
            float: {
              '0%, 100%': { transform: 'translateY(0)' },
              '50%': { transform: 'translateY(-10px)' }
            }
          }
        }
      }
    }
  </script>
  <style>
    .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .glass-effect {
      background: rgba(255, 255, 255, 0.25);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.18);
    }
    .dark .glass-effect {
      background: rgba(0, 0, 0, 0.25);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .task-card {
      transition: all 0.3s ease;
      border-left: 4px solid transparent;
    }
    .task-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
    }
    .priority-low { border-left-color: #10b981; }
    .priority-medium { border-left-color: #f59e0b; }
    .priority-high { border-left-color: #f97316; }
    .priority-urgent { border-left-color: #ef4444; }
    .status-pending { background-color: #fef3c7; color: #d97706; }
    .status-in_progress { background-color: #dbeafe; color: #1d4ed8; }
    .status-completed { background-color: #d1fae5; color: #065f46; }
    .status-cancelled { background-color: #f3f4f6; color: #6b7280; }
    .dark .status-pending { background-color: #78350f; color: #fef3c7; }
    .dark .status-in_progress { background-color: #1e3a8a; color: #dbeafe; }
    .dark .status-completed { background-color: #064e3b; color: #d1fae5; }
    .dark .status-cancelled { background-color: #374151; color: #f3f4f6; }
    .hover-lift { transition: all 0.3s ease; }
    .hover-lift:hover { transform: translateY(-3px); }
    .smooth-transition { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    .checkbox-custom {
      appearance: none;
      width: 20px;
      height: 20px;
      border: 2px solid #d1d5db;
      border-radius: 4px;
      outline: none;
      cursor: pointer;
      position: relative;
      transition: all 0.2s ease;
    }
    .checkbox-custom:checked {
      background-color: #10b981;
      border-color: #10b981;
    }
    .checkbox-custom:checked:before {
      content: '‚úì';
      position: absolute;
      color: white;
      font-size: 14px;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
    .progress-bar {
      height: 6px;
      border-radius: 3px;
      overflow: hidden;
      background-color: #e5e7eb;
    }
    .progress-fill {
      height: 100%;
      transition: width 0.5s ease;
      background: linear-gradient(90deg, #3b82f6, #8b5cf6);
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 50;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      animation: fadeIn 0.3s;
    }
    .modal.active { display: flex; }
    .modal-content {
      margin: auto;
      max-width: 800px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      animation: slideIn 0.3s;
    }
    .timer-display {
      font-size: 3rem;
      font-weight: bold;
      font-family: 'Courier New', monospace;
    }
    .pomodoro-timer {
      width: 200px;
      height: 200px;
      border-radius: 50%;
      border: 8px solid #e5e7eb;
      position: relative;
    }
    .dependency-line {
      position: relative;
    }
    .dependency-line:before {
      content: '';
      position: absolute;
      top: -10px;
      left: 20px;
      width: 2px;
      height: 20px;
      background-color: #d1d5db;
    }
    .dark { background: #0f172a; color: #f1f5f9; }
    .dark .bg-white { background: #1e293b; }
    .dark .text-gray-800 { color: #f1f5f9; }
    .dark .text-gray-600 { color: #cbd5e1; }
    .dark .text-gray-500 { color: #94a3b8; }
    .dark .border-gray-300 { border-color: #475569; }
    .dark .border-gray-200 { border-color: #334155; }
    .dark .border-gray-100 { border-color: #1e293b; }
    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .line-clamp-3 {
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 min-h-screen p-4" x-data="todoApp()" x-init="init()" :class="darkMode ? 'dark' : ''">
  <div class="max-w-7xl mx-auto">
    <!-- Header -->
    <div class="glass-effect rounded-2xl shadow-xl p-6 mb-6 animate-fade-in">
      <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-4">
        <div>
          <h1 class="text-3xl font-bold bg-gradient-to-r from-primary-600 to-purple-600 bg-clip-text text-transparent">
            <i class="fas fa-tasks mr-2"></i>Ultimate Todo Manager 2.0
          </h1>
          <p class="text-gray-600 dark:text-gray-400 mt-1">Advanced productivity with time tracking & analytics</p>
        </div>
        
        <div class="flex gap-2 flex-wrap">
          <button @click="darkMode = !darkMode" 
                  class="flex items-center gap-2 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300 px-4 py-2 rounded-lg transition-all duration-300 hover-lift shadow-sm">
            <i class="fas" :class="darkMode ? 'fa-sun' : 'fa-moon'"></i>
            <span x-text="darkMode ? 'Light' : 'Dark'"></span>
          </button>
          
          <button @click="showStats = !showStats" 
                  class="flex items-center gap-2 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700 text-gray-700 dark:text-gray-300 px-4 py-2 rounded-lg transition-all duration-300 hover-lift shadow-sm">
            <i class="fas fa-chart-bar"></i>
            <span x-text="showStats ? 'Hide Stats' : 'Show Stats'"></span>
          </button>
          
          <button @click="showDashboard = true" 
                  class="flex items-center gap-2 bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-2 rounded-lg transition-all duration-300 hover-lift shadow-sm">
            <i class="fas fa-tachometer-alt"></i>
            Dashboard
          </button>
          
          <button @click="showAnalytics = true" 
                  class="flex items-center gap-2 bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg transition-all duration-300 hover-lift shadow-sm">
            <i class="fas fa-chart-line"></i>
            Analytics
          </button>
          
          <button @click="showTemplates = true" 
                  class="flex items-center gap-2 bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-all duration-300 hover-lift shadow-sm">
            <i class="fas fa-file-alt"></i>
            Templates
          </button>
          
          <button @click="view = view === 'list' ? 'kanban' : 'list'" 
                  class="flex items-center gap-2 bg-primary-500 hover:bg-primary-600 text-white px-4 py-2 rounded-lg transition-all duration-300 hover-lift shadow-sm">
            <i class="fas" :class="view === 'list' ? 'fa-columns' : 'fa-list'"></i>
            <span x-text="view === 'list' ? 'Kanban' : 'List'"></span>
          </button>
          
          <div class="relative" x-data="{ exportOpen: false }">
            <button @click="exportOpen = !exportOpen" 
                    class="flex items-center gap-2 bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg transition-all duration-300 hover-lift shadow-sm">
              <i class="fas fa-download"></i>
              Export
            </button>
            <div x-show="exportOpen" @click.away="exportOpen = false" 
                 class="absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-lg shadow-xl z-10">
              <a :href="`/todos/export/json${filters.category ? '?category=' + filters.category : ''}`" 
                 class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-t-lg">
                <i class="fas fa-file-code mr-2"></i>JSON
              </a>
              <a :href="`/todos/export/csv${filters.category ? '?category=' + filters.category : ''}`" 
                 class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700">
                <i class="fas fa-file-csv mr-2"></i>CSV
              </a>
              <a href="/todos/export/ics" 
                 class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-b-lg">
                <i class="fas fa-calendar mr-2"></i>Calendar (ICS)
              </a>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Stats Panel -->
      <div x-show="showStats" x-collapse 
           class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4 mt-6 animate-slide-in">
        <div class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm border border-gray-100 dark:border-gray-700 hover-lift">
          <div class="text-2xl font-bold text-primary-600" x-text="stats.total"></div>
          <div class="text-sm text-gray-500 dark:text-gray-400 flex items-center gap-1">
            <i class="fas fa-tasks"></i> Total
          </div>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm border border-gray-100 dark:border-gray-700 hover-lift">
          <div class="text-2xl font-bold text-green-600" x-text="stats.completed"></div>
          <div class="text-sm text-gray-500 dark:text-gray-400 flex items-center gap-1">
            <i class="fas fa-check-circle"></i> Done
          </div>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm border border-gray-100 dark:border-gray-700 hover-lift">
          <div class="text-2xl font-bold text-yellow-600" x-text="stats.pending"></div>
          <div class="text-sm text-gray-500 dark:text-gray-400 flex items-center gap-1">
            <i class="fas fa-clock"></i> Pending
          </div>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm border border-gray-100 dark:border-gray-700 hover-lift">
          <div class="text-2xl font-bold text-blue-600" x-text="stats.in_progress"></div>
          <div class="text-sm text-gray-500 dark:text-gray-400 flex items-center gap-1">
            <i class="fas fa-spinner"></i> Active
          </div>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm border border-gray-100 dark:border-gray-700 hover-lift">
          <div class="text-2xl font-bold text-red-600" x-text="stats.overdue"></div>
          <div class="text-sm text-gray-500 dark:text-gray-400 flex items-center gap-1">
            <i class="fas fa-exclamation-triangle"></i> Overdue
          </div>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm border border-gray-100 dark:border-gray-700 hover-lift">
          <div class="text-2xl font-bold text-purple-600" x-text="`${stats.completion_rate}%`"></div>
          <div class="text-sm text-gray-500 dark:text-gray-400 flex items-center gap-1">
            <i class="fas fa-chart-line"></i> Rate
          </div>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm border border-gray-100 dark:border-gray-700 hover-lift">
          <div class="text-2xl font-bold text-orange-600" x-text="stats.streak_days || 0"></div>
          <div class="text-sm text-gray-500 dark:text-gray-400 flex items-center gap-1">
            <i class="fas fa-fire"></i> Streak
          </div>
        </div>
      </div>

      <!-- Progress Bar -->
      <div class="mt-6" x-show="showStats">
        <div class="flex justify-between text-sm text-gray-600 dark:text-gray-400 mb-1">
          <span>Overall Progress</span>
          <span x-text="`${stats.completion_rate}%`"></span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" :style="`width: ${stats.completion_rate}%`"></div>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
      <!-- Left Panel - Add Task & Quick Actions -->
      <div class="lg:col-span-1 space-y-6">
        <!-- Add Task Card -->
        <div class="glass-effect rounded-2xl shadow-xl p-6 animate-fade-in">
          <h2 class="text-xl font-bold mb-4 text-gray-800 dark:text-gray-100 flex items-center gap-2">
            <i class="fas fa-plus-circle text-primary-500"></i>
            <span>Add New Task</span>
          </h2>
          
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Title *</label>
              <input x-model="newTodo.title" placeholder="What needs to be done?" 
                     class="w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-primary-400 transition-all duration-300">
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Description</label>
              <textarea x-model="newTodo.description" placeholder="Add details..." 
                        class="w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-primary-400 transition-all duration-300 h-24"></textarea>
            </div>
            
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Priority</label>
                <select x-model="newTodo.priority" class="w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-primary-400">
                  <option value="low">üü¢ Low</option>
                  <option value="medium" selected>üü° Medium</option>
                  <option value="high">üü† High</option>
                  <option value="urgent">üî¥ Urgent</option>
                </select>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Status</label>
                <select x-model="newTodo.status" class="w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-primary-400">
                  <option value="pending">‚è≥ Pending</option>
                  <option value="in_progress">üîÑ In Progress</option>
                  <option value="completed">‚úÖ Completed</option>
                </select>
              </div>
            </div>
            
            <div class="grid grid-cols-2 gap-3">
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Due Date</label>
                <input type="datetime-local" x-model="newTodo.due_date" 
                       class="w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-primary-400">
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Duration (min)</label>
                <input type="number" x-model="newTodo.estimated_duration" placeholder="60" 
                       class="w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-primary-400">
              </div>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Recurring</label>
              <select x-model="newTodo.recurrence_pattern" class="w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-primary-400">
                <option value="none">üö´ None</option>
                <option value="daily">üìÖ Daily</option>
                <option value="weekly">üìÜ Weekly</option>
                <option value="monthly">üóìÔ∏è Monthly</option>
                <option value="yearly">üéÇ Yearly</option>
              </select>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Pomodoro Target</label>
              <input type="number" x-model="newTodo.pomodoro_target" placeholder="4" 
                     class="w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-primary-400">
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Reminder</label>
              <input type="datetime-local" x-model="newTodo.reminder_datetime" 
                     class="w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-primary-400">
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Category</label>
              <select x-model="newTodo.category_id" class="w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-primary-400">
                <option value="">No Category</option>
                <template x-for="category in categories" :key="category.id">
                  <option :value="category.id" x-text="category.name"></option>
                </template>
              </select>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Dependencies</label>
              <select x-model="newTodo.dependency_ids" multiple class="w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-primary-400 h-32">
                <template x-for="todo in todos" :key="todo.id">
                  <option :value="todo.id" x-text="todo.title"></option>
                </template>
              </select>
              <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Hold Ctrl/Cmd to select multiple</p>
            </div>
            
            <button @click="addTodo" 
                    class="w-full bg-gradient-to-r from-primary-500 to-purple-500 hover:from-primary-600 hover:to-purple-600 text-white rounded-lg px-4 py-3 font-semibold transition-all duration-300 hover-lift shadow-md flex items-center justify-center gap-2">
              <i class="fas fa-plus"></i>
              Add Task
            </button>
          </div>
        </div>

        <!-- Timer & Pomodoro Card -->
        <div class="glass-effect rounded-2xl shadow-xl p-6 animate-fade-in">
          <h3 class="text-lg font-bold mb-4 text-gray-800 dark:text-gray-100 flex items-center gap-2">
            <i class="fas fa-stopwatch text-red-500"></i>
            <span>Timer & Pomodoro</span>
          </h3>
          
          <div x-show="activeTimer.todo_id" class="space-y-4">
            <div class="text-center">
              <div class="timer-display text-primary-600 animate-timer-pulse" x-text="formatTimerDisplay(activeTimer.elapsed_seconds)"></div>
              <p class="text-sm text-gray-600 dark:text-gray-400" x-text="'Working on: ' + (activeTimer.title || 'Task')"></p>
            </div>
            
            <div class="grid grid-cols-2 gap-2">
              <button @click="stopTimer(activeTimer.todo_id)" 
                      class="bg-red-500 hover:bg-red-600 text-white rounded-lg p-3 transition-all duration-300 hover-lift flex items-center justify-center gap-2">
                <i class="fas fa-stop"></i>
                Stop
              </button>
              <button @click="completePomodoro(activeTimer.todo_id)" 
                      class="bg-green-500 hover:bg-green-600 text-white rounded-lg p-3 transition-all duration-300 hover-lift flex items-center justify-center gap-2">
                <i class="fas fa-check"></i>
                Complete
              </button>
            </div>
            
            <div class="text-sm text-gray-600 dark:text-gray-400 text-center">
              <span>Pomodoros: </span>
              <span class="font-bold" x-text="activeTimer.pomodoro_count || 0"></span>
              <span x-show="activeTimer.pomodoro_target"> / <span x-text="activeTimer.pomodoro_target"></span></span>
            </div>
          </div>
          
          <div x-show="!activeTimer.todo_id" class="text-center text-gray-500 dark:text-gray-400 py-8">
            <i class="fas fa-clock text-4xl mb-2"></i>
            <p>No active timer</p>
            <p class="text-xs">Start a timer from any task</p>
          </div>
        </div>

        <!-- Category Management -->
        <div class="glass-effect rounded-2xl shadow-xl p-6 animate-fade-in">
          <h3 class="text-lg font-bold mb-4 text-gray-800 dark:text-gray-100 flex items-center gap-2">
            <i class="fas fa-folder text-yellow-500"></i>
            <span>Categories</span>
          </h3>
          
          <div class="space-y-3 mb-4 max-h-40 overflow-y-auto">
            <template x-for="category in categories" :key="category.id">
              <div class="flex items-center justify-between bg-white dark:bg-gray-800 rounded-lg p-2">
                <div class="flex items-center gap-2">
                  <div class="w-4 h-4 rounded-full" :style="`background-color: ${category.color}`"></div>
                  <span x-text="category.name"></span>
                </div>
                <button @click="deleteCategory(category.id)" class="text-red-500 hover:text-red-700">
                  <i class="fas fa-trash text-xs"></i>
                </button>
              </div>
            </template>
          </div>
          
          <div class="flex gap-2">
            <input x-model="newCategory.name" placeholder="New category" 
                   class="flex-1 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 rounded-lg p-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary-400">
            <button @click="addCategory" class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 rounded-lg text-sm">
              <i class="fas fa-plus"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- Main Content Area -->
      <div class="lg:col-span-3">
        <!-- Filters Card -->
        <div class="glass-effect rounded-2xl shadow-xl p-6 mb-6 animate-fade-in">
          <div class="flex flex-col md:flex-row gap-4 justify-between items-start md:items-center">
            <div class="flex-1 w-full md:w-auto">
              <div class="relative">
                <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                <input x-model="filters.search" @input="debouncedFetchTodos" placeholder="Search tasks..." 
                       class="w-full pl-10 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-primary-400">
              </div>
            </div>

            <div class="flex gap-2 flex-wrap">
              <select x-model="filters.status" @change="fetchTodos" 
                      class="border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 rounded-lg p-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary-400">
                <option value="">All Status</option>
                <option value="pending">Pending</option>
                <option value="in_progress">In Progress</option>
                <option value="completed">Completed</option>
              </select>
              
              <select x-model="filters.priority" @change="fetchTodos" 
                      class="border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 rounded-lg p-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary-400">
                <option value="">All Priorities</option>
                <option value="low">Low</option>
                <option value="medium">Medium</option>
                <option value="high">High</option>
                <option value="urgent">Urgent</option>
              </select>
              
              <select x-model="filters.category" @change="fetchTodos" 
                      class="border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 rounded-lg p-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary-400">
                <option value="">All Categories</option>
                <template x-for="category in categories" :key="category.id">
                  <option :value="category.name" x-text="category.name"></option>
                </template>
              </select>
              
              <select x-model="filters.sort_by" @change="fetchTodos" 
                      class="border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 rounded-lg p-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary-400">
                <option value="created_at">Newest First</option>
                <option value="due_date">Due Date</option>
                <option value="priority">Priority</option>
                <option value="title">Title</option>
              </select>
              
              <label class="flex items-center gap-2 text-sm text-gray-700 dark:text-gray-300">
                <input type="checkbox" x-model="filters.include_archived" @change="fetchTodos" class="rounded">
                Show Archived
              </label>
            </div>
          </div>

          <div x-show="selectedTodos.length > 0" class="flex gap-2 flex-wrap mt-4 animate-slide-in">
            <button @click="bulkComplete" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm transition-all duration-300 hover-lift flex items-center gap-2">
              <i class="fas fa-check"></i>
              Complete (<span x-text="selectedTodos.length"></span>)
            </button>
            <button @click="bulkArchive" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg text-sm transition-all duration-300 hover-lift flex items-center gap-2">
              <i class="fas fa-archive"></i>
              Archive
            </button>
            <button @click="bulkDelete" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm transition-all duration-300 hover-lift flex items-center gap-2">
              <i class="fas fa-trash"></i>
              Delete
            </button>
            <button @click="selectedTodos = []" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm transition-all duration-300 hover-lift flex items-center gap-2">
              <i class="fas fa-times"></i>
              Clear
            </button>
          </div>
        </div>

        <!-- List View -->
        <template x-if="view === 'list'">
          <div class="glass-effect rounded-2xl shadow-xl p-6 animate-fade-in">
            <div class="flex justify-between items-center mb-6">
              <h2 class="text-xl font-bold text-gray-800 dark:text-gray-100 flex items-center gap-2">
                <i class="fas fa-list-ul text-primary-500"></i>
                <span>Your Tasks</span>
              </h2>
              <span class="text-sm text-gray-500 dark:text-gray-400" x-text="`${todos.length} tasks`"></span>
            </div>

            <div class="space-y-4 max-h-[700px] overflow-y-auto pr-2">
              <template x-if="todos.length === 0">
                <div class="text-center py-12 text-gray-500 dark:text-gray-400 animate-pulse-soft">
                  <div class="text-6xl mb-4">üìù</div>
                  <p class="text-lg">No tasks found. Create one to get started!</p>
                </div>
              </template>

              <template x-for="todo in todos" :key="todo.id">
                <div class="task-card bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm border border-gray-100 dark:border-gray-700 smooth-transition"
                     :class="`priority-${todo.priority}`">
                  <div class="flex items-start gap-4">
                    <input type="checkbox" 
                           :checked="selectedTodos.includes(todo.id)"
                           @change="toggleSelection(todo.id)"
                           class="checkbox-custom mt-1">
                    
                    <input type="checkbox" 
                           :checked="todo.status === 'completed'" 
                           @change="toggleStatus(todo)" 
                           class="checkbox-custom mt-1">
                    
                    <div class="flex-1 min-w-0">
                      <div class="flex flex-wrap items-center gap-2 mb-2">
                        <h3 class="font-semibold text-lg truncate flex-1" 
                            :class="todo.status === 'completed' ? 'line-through text-gray-500' : 'text-gray-800 dark:text-gray-100'"
                            x-text="todo.title"></h3>
                        
                        <span class="px-2 py-1 rounded-full text-xs font-medium capitalize"
                              :class="{
                                'status-pending': todo.status === 'pending',
                                'status-in_progress': todo.status === 'in_progress',
                                'status-completed': todo.status === 'completed'
                              }"
                              x-text="todo.status.replace('_', ' ')"></span>
                        
                        <span x-show="todo.is_archived" 
                              class="px-2 py-1 bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-300 rounded-full text-xs">
                          <i class="fas fa-archive mr-1"></i>Archived
                        </span>
                      </div>
                      
                      <p x-show="todo.description" 
                         class="text-sm text-gray-600 dark:text-gray-400 mb-3 line-clamp-2" 
                         x-text="todo.description"></p>
                      
                      <!-- Meta Information -->
                      <div class="flex flex-wrap gap-2 text-xs mb-3">
                        <span class="px-2 py-1 rounded-full flex items-center gap-1"
                              :class="{
                                'bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-300': todo.priority === 'low',
                                'bg-yellow-100 text-yellow-700 dark:bg-yellow-900 dark:text-yellow-300': todo.priority === 'medium',
                                'bg-orange-100 text-orange-700 dark:bg-orange-900 dark:text-orange-300': todo.priority === 'high',
                                'bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-300': todo.priority === 'urgent'
                              }">
                          <i class="fas fa-flag"></i>
                          <span x-text="todo.priority" class="capitalize"></span>
                        </span>
                        
                        <span x-show="todo.due_date" 
                              class="px-2 py-1 rounded-full flex items-center gap-1"
                              :class="isOverdue(todo.due_date) ? 'bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-300' : 'bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300'">
                          <i class="fas fa-calendar"></i>
                          <span x-text="formatDate(todo.due_date)"></span>
                        </span>
                        
                        <span x-show="todo.estimated_duration" 
                              class="px-2 py-1 bg-purple-100 text-purple-700 dark:bg-purple-900 dark:text-purple-300 rounded-full flex items-center gap-1">
                          <i class="fas fa-clock"></i>
                          <span x-text="`${todo.estimated_duration} min`"></span>
                        </span>
                        
                        <span x-show="todo.actual_duration" 
                              class="px-2 py-1 bg-indigo-100 text-indigo-700 dark:bg-indigo-900 dark:text-indigo-300 rounded-full flex items-center gap-1">
                          <i class="fas fa-stopwatch"></i>
                          <span x-text="`${todo.actual_duration} min tracked`"></span>
                        </span>
                        
                        <span x-show="todo.pomodoro_count > 0" 
                              class="px-2 py-1 bg-pink-100 text-pink-700 dark:bg-pink-900 dark:text-pink-300 rounded-full flex items-center gap-1">
                          <i class="fas fa-tomato"></i>
                          <span x-text="`${todo.pomodoro_count} üçÖ`"></span>
                        </span>
                        
                        <span x-show="todo.recurrence_pattern !== 'none'" 
                              class="px-2 py-1 bg-cyan-100 text-cyan-700 dark:bg-cyan-900 dark:text-cyan-300 rounded-full flex items-center gap-1">
                          <i class="fas fa-sync"></i>
                          <span x-text="todo.recurrence_pattern" class="capitalize"></span>
                        </span>
                        
                        <span x-show="todo.category" 
                              class="px-2 py-1 bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-300 rounded-full flex items-center gap-1">
                          <i class="fas fa-folder"></i>
                          <span x-text="todo.category.name"></span>
                        </span>
                      </div>
                      
                      <!-- Subtasks -->
                      <div x-show="todo.subtasks && todo.subtasks.length > 0" class="mb-3">
                        <div class="text-xs text-gray-500 dark:text-gray-400 mb-1">Subtasks:</div>
                        <div class="space-y-1 ml-4">
                          <template x-for="subtask in todo.subtasks" :key="subtask.id">
                            <div class="flex items-center gap-2">
                              <input type="checkbox" 
                                     :checked="subtask.status === 'completed'" 
                                     @change="toggleSubtaskStatus(subtask)" 
                                     class="checkbox-custom" style="width: 16px; height: 16px;">
                              <span class="text-xs" 
                                    :class="subtask.status === 'completed' ? 'line-through text-gray-500' : 'text-gray-700 dark:text-gray-300'"
                                    x-text="subtask.title"></span>
                            </div>
                          </template>
                        </div>
                      </div>
                      
                      <!-- Dependencies -->
                      <div x-show="todo.dependencies && todo.dependencies.length > 0" class="mb-3">
                        <div class="text-xs text-gray-500 dark:text-gray-400 mb-1">Depends on:</div>
                        <div class="flex flex-wrap gap-1 ml-4">
                          <template x-for="dep in todo.dependencies" :key="dep.id">
                            <span class="px-2 py-1 bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300 rounded-full text-xs flex items-center gap-1">
                              <i class="fas fa-link"></i>
                              <span x-text="dep.title"></span>
                              <span x-show="dep.status === 'completed'" class="text-green-500">
                                <i class="fas fa-check"></i>
                              </span>
                            </span>
                          </template>
                        </div>
                      </div>
                      
                      <!-- Action Buttons -->
                      <div class="flex gap-2 flex-wrap">
                        <button @click="startTimer(todo)" 
                                x-show="!todo.timer_started_at && todo.status !== 'completed'"
                                class="text-xs bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded-lg transition-all duration-300 flex items-center gap-1">
                          <i class="fas fa-play"></i> Start Timer
                        </button>
                        
                        <button @click="stopTimer(todo.id)" 
                                x-show="todo.timer_started_at"
                                class="text-xs bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-lg transition-all duration-300 flex items-center gap-1">
                          <i class="fas fa-stop"></i> Stop Timer
                        </button>
                        
                        <button @click="openComments(todo)" 
                                class="text-xs bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-lg transition-all duration-300 flex items-center gap-1">
                          <i class="fas fa-comments"></i> Comments (<span x-text="todo.comments?.length || 0"></span>)
                        </button>
                        
                        <button @click="openActivityLog(todo)" 
                                class="text-xs bg-purple-500 hover:bg-purple-600 text-white px-3 py-1 rounded-lg transition-all duration-300 flex items-center gap-1">
                          <i class="fas fa-history"></i> Activity
                        </button>
                        
                        <button @click="getSmartSuggestions(todo)" 
                                class="text-xs bg-indigo-500 hover:bg-indigo-600 text-white px-3 py-1 rounded-lg transition-all duration-300 flex items-center gap-1">
                          <i class="fas fa-lightbulb"></i> Suggestions
                        </button>
                        
                        <button @click="makeTemplate(todo)" 
                                class="text-xs bg-orange-500 hover:bg-orange-600 text-white px-3 py-1 rounded-lg transition-all duration-300 flex items-center gap-1">
                          <i class="fas fa-save"></i> Save as Template
                        </button>
                        
                        <button @click="createNextRecurringInstance(todo)" 
                                x-show="todo.recurrence_pattern !== 'none' && todo.status === 'completed'"
                                class="text-xs bg-cyan-500 hover:bg-cyan-600 text-white px-3 py-1 rounded-lg transition-all duration-300 flex items-center gap-1">
                          <i class="fas fa-redo"></i> Create Next
                        </button>
                        
                        <button @click="toggleArchive(todo)" 
                                class="text-xs bg-gray-500 hover:bg-gray-600 text-white px-3 py-1 rounded-lg transition-all duration-300 flex items-center gap-1">
                          <i class="fas" :class="todo.is_archived ? 'fa-box-open' : 'fa-archive'"></i>
                          <span x-text="todo.is_archived ? 'Unarchive' : 'Archive'"></span>
                        </button>
                        
                        <button @click="addSubtask(todo)" 
                                class="text-xs bg-teal-500 hover:bg-teal-600 text-white px-3 py-1 rounded-lg transition-all duration-300 flex items-center gap-1">
                          <i class="fas fa-plus"></i> Add Subtask
                        </button>
                      </div>
                    </div>
                    
                    <!-- Action Icons -->
                    <div class="flex flex-col gap-2">
                      <button @click="editTodo(todo)" 
                              class="text-blue-500 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 p-2 rounded-full hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-all duration-300">
                        <i class="fas fa-edit"></i>
                      </button>
                      <button @click="deleteTodo(todo.id)" 
                              class="text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300 p-2 rounded-full hover:bg-red-50 dark:hover:bg-red-900/20 transition-all duration-300">
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </template>
            </div>
          </div>
        </template>

        <!-- Kanban View -->
        <template x-if="view === 'kanban'">
          <div class="animate-fade-in">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
              <template x-for="status in ['pending', 'in_progress', 'completed']" :key="status">
                <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6">
                  <h3 class="text-lg font-bold mb-4 text-gray-800 dark:text-gray-100 flex items-center gap-2 capitalize"
                      x-text="status.replace('_', ' ')"></h3>
                  
                  <div class="space-y-4 min-h-64 max-h-[600px] overflow-y-auto">
                    <template x-for="todo in getTodosByStatus(status)" :key="todo.id">
                      <div class="task-card bg-gray-50 dark:bg-gray-700 rounded-xl p-4 border border-gray-200 dark:border-gray-600 smooth-transition cursor-move"
                           :class="`priority-${todo.priority}`">
                        <div class="flex justify-between items-start mb-2">
                          <h4 class="font-semibold text-gray-800 dark:text-gray-100" x-text="todo.title"></h4>
                          <button @click="deleteTodo(todo.id)" class="text-red-500 hover:text-red-700 text-sm">
                            <i class="fas fa-trash"></i>
                          </button>
                        </div>
                        
                        <p x-show="todo.description" class="text-sm text-gray-600 dark:text-gray-400 mb-3 line-clamp-2" 
                           x-text="todo.description"></p>
                        
                        <div class="flex justify-between items-center text-xs">
                          <span x-text="formatDate(todo.due_date)" x-show="todo.due_date" 
                                class="text-gray-500 dark:text-gray-400"></span>
                          <span x-text="todo.priority" class="capitalize font-semibold"
                                :class="{
                                  'text-green-600': todo.priority === 'low',
                                  'text-yellow-600': todo.priority === 'medium',
                                  'text-orange-600': todo.priority === 'high',
                                  'text-red-600': todo.priority === 'urgent'
                                }"></span>
                        </div>
                      </div>
                    </template>
                    
                    <div x-show="getTodosByStatus(status).length === 0" 
                         class="text-center py-8 text-gray-400 dark:text-gray-500 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-xl">
                      <i class="fas fa-inbox text-2xl mb-2"></i>
                      <p>No tasks</p>
                    </div>
                  </div>
                </div>
              </template>
            </div>
          </div>
        </template>
      </div>
    </div>
  </div>

  <!-- Dashboard Modal -->
  <div class="modal" :class="showDashboard ? 'active' : ''" @click.self="showDashboard = false">
    <div class="modal-content glass-effect rounded-2xl p-6 max-w-5xl">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100">
          <i class="fas fa-tachometer-alt text-indigo-500 mr-2"></i>
          Dashboard Overview
        </h2>
        <button @click="showDashboard = false" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
          <i class="fas fa-times text-2xl"></i>
        </button>
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
        <div class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm">
          <h3 class="font-bold mb-2 text-gray-800 dark:text-gray-100">Productivity Score</h3>
          <div class="text-3xl font-bold text-primary-600" x-text="dashboardStats?.productivity_score || 'N/A'"></div>
          <div class="text-sm text-gray-500 dark:text-gray-400">Based on completion rate & efficiency</div>
        </div>
        
        <div class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm">
          <h3 class="font-bold mb-2 text-gray-800 dark:text-gray-100">Focus Time</h3>
          <div class="text-3xl font-bold text-green-600" x-text="`${dashboardStats?.total_focus_time || 0} min`"></div>
          <div class="text-sm text-gray-500 dark:text-gray-400">Time spent on tasks</div>
        </div>
        
        <div class="bg-white dark:bg-gray-800 rounded-xl p-4 shadow-sm">
          <h3 class="font-bold mb-2 text-gray-800 dark:text-gray-100">Task Velocity</h3>
          <div class="text-3xl font-bold text-purple-600" x-text="`${dashboardStats?.tasks_per_day || 0}/day`"></div>
          <div class="text-sm text-gray-500 dark:text-gray-400">Average tasks completed</div>
        </div>
      </div>
      
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="bg-white dark:bg-gray-800 rounded-xl p-4">
          <h3 class="font-bold mb-4 text-gray-800 dark:text-gray-100">Upcoming Tasks</h3>
          <div class="space-y-3 max-h-60 overflow-y-auto">
            <template x-for="task in dashboardUpcoming" :key="task.id">
              <div class="flex justify-between items-center p-3 border border-gray-200 dark:border-gray-700 rounded-lg">
                <div>
                  <div class="font-medium" x-text="task.title"></div>
                  <div class="text-xs text-gray-500" x-text="formatDate(task.due_date)"></div>
                </div>
                <span class="px-2 py-1 text-xs rounded-full capitalize"
                      :class="{
                        'bg-green-100 text-green-800': task.priority === 'low',
                        'bg-yellow-100 text-yellow-800': task.priority === 'medium',
                        'bg-orange-100 text-orange-800': task.priority === 'high',
                        'bg-red-100 text-red-800': task.priority === 'urgent'
                      }"
                      x-text="task.priority"></span>
              </div>
            </template>
            
            <div x-show="dashboardUpcoming.length === 0" class="text-center py-4 text-gray-500">
              <i class="fas fa-check-circle text-2xl mb-2"></i>
              <p>No upcoming tasks</p>
            </div>
          </div>
        </div>
        
        <div class="bg-white dark:bg-gray-800 rounded-xl p-4">
          <h3 class="font-bold mb-4 text-gray-800 dark:text-gray-100">Recent Activity</h3>
          <div class="space-y-3 max-h-60 overflow-y-auto">
            <template x-for="activity in dashboardActivity" :key="activity.id">
              <div class="p-3 border border-gray-200 dark:border-gray-700 rounded-lg">
                <div class="flex items-center gap-2 mb-1">
                  <span class="px-2 py-1 bg-primary-100 text-primary-700 rounded-full text-xs font-medium" 
                        x-text="activity.action"></span>
                  <span class="text-xs text-gray-500" x-text="formatDateTime(activity.timestamp)"></span>
                </div>
                <div class="text-sm" x-text="activity.details?.title || 'Task updated'"></div>
              </div>
            </template>
            
            <div x-show="dashboardActivity.length === 0" class="text-center py-4 text-gray-500">
              <i class="fas fa-history text-2xl mb-2"></i>
              <p>No recent activity</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Analytics Modal -->
  <div class="modal" :class="showAnalytics ? 'active' : ''" @click.self="showAnalytics = false">
    <div class="modal-content glass-effect rounded-2xl p-6">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100">
          <i class="fas fa-chart-line text-purple-500 mr-2"></i>
          Productivity Analytics
        </h2>
        <button @click="showAnalytics = false" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
          <i class="fas fa-times text-2xl"></i>
        </button>
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
        <div class="bg-white dark:bg-gray-800 rounded-xl p-4">
          <h3 class="font-bold mb-2 text-gray-800 dark:text-gray-100">Total Time Tracked</h3>
          <p class="text-3xl font-bold text-primary-600" x-text="`${stats.total_time_tracked || 0} min`"></p>
          <p class="text-sm text-gray-500 dark:text-gray-400" x-text="`${Math.floor((stats.total_time_tracked || 0) / 60)} hours`"></p>
        </div>
        
        <div class="bg-white dark:bg-gray-800 rounded-xl p-4">
          <h3 class="font-bold mb-2 text-gray-800 dark:text-gray-100">Pomodoros Completed</h3>
          <p class="text-3xl font-bold text-red-600" x-text="stats.pomodoros_completed || 0"></p>
          <p class="text-sm text-gray-500 dark:text-gray-400">üçÖ Focus sessions</p>
        </div>
        
        <div class="bg-white dark:bg-gray-800 rounded-xl p-4">
          <h3 class="font-bold mb-2 text-gray-800 dark:text-gray-100">Current Streak</h3>
          <p class="text-3xl font-bold text-orange-600" x-text="`${stats.streak_days || 0} days`"></p>
          <p class="text-sm text-gray-500 dark:text-gray-400">üî• Keep it going!</p>
        </div>
        
        <div class="bg-white dark:bg-gray-800 rounded-xl p-4">
          <h3 class="font-bold mb-2 text-gray-800 dark:text-gray-100">Avg Completion Time</h3>
          <p class="text-3xl font-bold text-green-600" x-text="`${stats.average_completion_time || 0}h`"></p>
          <p class="text-sm text-gray-500 dark:text-gray-400">Per task</p>
        </div>
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="bg-white dark:bg-gray-800 rounded-xl p-4">
          <h3 class="font-bold mb-4 text-gray-800 dark:text-gray-100">7-Day Productivity Trend</h3>
          <canvas id="productivityChart"></canvas>
        </div>
        
        <div class="bg-white dark:bg-gray-800 rounded-xl p-4">
          <h3 class="font-bold mb-4 text-gray-800 dark:text-gray-100">Time by Category</h3>
          <canvas id="categoryChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Templates Modal -->
  <div class="modal" :class="showTemplates ? 'active' : ''" @click.self="showTemplates = false">
    <div class="modal-content glass-effect rounded-2xl p-6">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100">
          <i class="fas fa-file-alt text-green-500 mr-2"></i>
          Task Templates
        </h2>
        <button @click="showTemplates = false" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
          <i class="fas fa-times text-2xl"></i>
        </button>
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <template x-for="template in templates" :key="template.id">
          <div class="bg-white dark:bg-gray-800 rounded-xl p-4 border border-gray-200 dark:border-gray-700 hover:shadow-lg transition-all duration-300">
            <h3 class="font-bold text-lg mb-2 text-gray-800 dark:text-gray-100" x-text="template.template_name"></h3>
            <p class="text-sm text-gray-600 dark:text-gray-400 mb-3" x-text="template.description"></p>
            <div class="flex gap-2">
              <span class="text-xs px-2 py-1 bg-primary-100 text-primary-700 dark:bg-primary-900 dark:text-primary-300 rounded-full" 
                    x-text="template.priority"></span>
              <span x-show="template.estimated_duration" 
                    class="text-xs px-2 py-1 bg-purple-100 text-purple-700 dark:bg-purple-900 dark:text-purple-300 rounded-full" 
                    x-text="`${template.estimated_duration} min`"></span>
            </div>
            <button @click="createFromTemplate(template.id)" 
                    class="w-full mt-3 bg-green-500 hover:bg-green-600 text-white rounded-lg py-2 transition-all duration-300">
              <i class="fas fa-plus mr-2"></i>Create from Template
            </button>
          </div>
        </template>
        
        <div x-show="templates.length === 0" class="col-span-2 text-center py-12 text-gray-500 dark:text-gray-400">
          <i class="fas fa-inbox text-4xl mb-2"></i>
          <p>No templates yet. Save a task as template to get started!</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Comments Modal -->
  <div class="modal" :class="showCommentsModal ? 'active' : ''" @click.self="showCommentsModal = false">
    <div class="modal-content glass-effect rounded-2xl p-6">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100">
          <i class="fas fa-comments text-blue-500 mr-2"></i>
          Comments
        </h2>
        <button @click="showCommentsModal = false" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
          <i class="fas fa-times text-2xl"></i>
        </button>
      </div>
      
      <div class="space-y-4 mb-4 max-h-96 overflow-y-auto">
        <template x-for="comment in currentComments" :key="comment.id">
          <div class="bg-white dark:bg-gray-800 rounded-lg p-4 border border-gray-200 dark:border-gray-700">
            <p class="text-gray-800 dark:text-gray-100" x-text="comment.content"></p>
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-2" x-text="formatDateTime(comment.created_at)"></p>
          </div>
        </template>
        
        <div x-show="currentComments.length === 0" class="text-center py-8 text-gray-500 dark:text-gray-400">
          <i class="fas fa-inbox text-3xl mb-2"></i>
          <p>No comments yet</p>
        </div>
      </div>
      
      <div class="flex gap-2">
        <input x-model="newComment" 
               placeholder="Add a comment..." 
               @keyup.enter="addComment"
               class="flex-1 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-primary-400">
        <button @click="addComment" 
                class="bg-blue-500 hover:bg-blue-600 text-white px-6 rounded-lg transition-all duration-300">
          <i class="fas fa-paper-plane"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Activity Log Modal -->
  <div class="modal" :class="showActivityModal ? 'active' : ''" @click.self="showActivityModal = false">
    <div class="modal-content glass-effect rounded-2xl p-6">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100">
          <i class="fas fa-history text-purple-500 mr-2"></i>
          Activity Log
        </h2>
        <button @click="showActivityModal = false" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
          <i class="fas fa-times text-2xl"></i>
        </button>
      </div>
      
      <div class="space-y-3 max-h-96 overflow-y-auto">
        <template x-for="activity in currentActivity" :key="activity.id">
          <div class="bg-white dark:bg-gray-800 rounded-lg p-4 border-l-4 border-primary-500">
            <div class="flex items-center gap-2 mb-2">
              <span class="px-2 py-1 bg-primary-100 dark:bg-primary-900 text-primary-700 dark:text-primary-300 rounded-full text-xs font-medium" 
                    x-text="activity.action"></span>
              <span class="text-xs text-gray-500 dark:text-gray-400" x-text="formatDateTime(activity.timestamp)"></span>
            </div>
            <pre class="text-sm text-gray-600 dark:text-gray-400 whitespace-pre-wrap" x-text="JSON.stringify(activity.details, null, 2)"></pre>
          </div>
        </template>
        
        <div x-show="currentActivity.length === 0" class="text-center py-8 text-gray-500 dark:text-gray-400">
          <i class="fas fa-inbox text-3xl mb-2"></i>
          <p>No activity yet</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Smart Suggestions Modal -->
  <div class="modal" :class="showSuggestionsModal ? 'active' : ''" @click.self="showSuggestionsModal = false">
    <div class="modal-content glass-effect rounded-2xl p-6">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100">
          <i class="fas fa-lightbulb text-indigo-500 mr-2"></i>
          Smart Suggestions
        </h2>
        <button @click="showSuggestionsModal = false" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
          <i class="fas fa-times text-2xl"></i>
        </button>
      </div>
      
      <div class="space-y-4">
        <template x-for="suggestion in currentSuggestions" :key="suggestion.type">
          <div class="bg-white dark:bg-gray-800 rounded-lg p-4 border-l-4"
               :class="{
                 'border-yellow-500': suggestion.type === 'warning',
                 'border-blue-500': suggestion.type === 'info',
                 'border-green-500': suggestion.type === 'tip'
               }">
            <div class="flex items-start gap-3">
              <i class="fas mt-1"
                 :class="{
                   'fa-exclamation-triangle text-yellow-500': suggestion.type === 'warning',
                   'fa-info-circle text-blue-500': suggestion.type === 'info',
                   'fa-lightbulb text-green-500': suggestion.type === 'tip'
                 }"></i>
              <div>
                <p class="text-gray-800 dark:text-gray-100" x-text="suggestion.message"></p>
              </div>
            </div>
          </div>
        </template>
        
        <div x-show="currentSuggestions.length === 0" class="text-center py-8 text-gray-500 dark:text-gray-400">
          <i class="fas fa-check-circle text-3xl mb-2"></i>
          <p>No suggestions for this task</p>
          <p class="text-sm">Everything looks good!</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Todo Modal -->
  <div class="modal" :class="showEditModal ? 'active' : ''" @click.self="showEditModal = false">
    <div class="modal-content glass-effect rounded-2xl p-6">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100">
          <i class="fas fa-edit text-blue-500 mr-2"></i>
          Edit Task
        </h2>
        <button @click="showEditModal = false" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
          <i class="fas fa-times text-2xl"></i>
        </button>
      </div>
      
      <div class="space-y-4" x-show="editingTodo">
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Title *</label>
          <input x-model="editingTodo.title" 
                 class="w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-primary-400 transition-all duration-300">
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Description</label>
          <textarea x-model="editingTodo.description" 
                    class="w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-primary-400 transition-all duration-300 h-24"></textarea>
        </div>
        
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Priority</label>
            <select x-model="editingTodo.priority" class="w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-primary-400">
              <option value="low">üü¢ Low</option>
              <option value="medium">üü° Medium</option>
              <option value="high">üü† High</option>
              <option value="urgent">üî¥ Urgent</option>
            </select>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Status</label>
            <select x-model="editingTodo.status" class="w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-primary-400">
              <option value="pending">‚è≥ Pending</option>
              <option value="in_progress">üîÑ In Progress</option>
              <option value="completed">‚úÖ Completed</option>
            </select>
          </div>
        </div>
        
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Due Date</label>
            <input type="datetime-local" x-model="editingTodo.due_date" 
                   class="w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-primary-400">
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Duration (min)</label>
            <input type="number" x-model="editingTodo.estimated_duration" 
                   class="w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-primary-400">
          </div>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Recurring</label>
          <select x-model="editingTodo.recurrence_pattern" class="w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-primary-400">
            <option value="none">üö´ None</option>
            <option value="daily">üìÖ Daily</option>
            <option value="weekly">üìÜ Weekly</option>
            <option value="monthly">üóìÔ∏è Monthly</option>
            <option value="yearly">üéÇ Yearly</option>
          </select>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Reminder</label>
          <input type="datetime-local" x-model="editingTodo.reminder_datetime" 
                 class="w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-primary-400">
        </div>
        
        <div class="flex gap-4">
          <button @click="updateTodo" 
                  class="flex-1 bg-blue-500 hover:bg-blue-600 text-white rounded-lg px-4 py-3 font-semibold transition-all duration-300 hover-lift">
            Update Task
          </button>
          <button @click="showEditModal = false" 
                  class="flex-1 bg-gray-500 hover:bg-gray-600 text-white rounded-lg px-4 py-3 font-semibold transition-all duration-300 hover-lift">
            Cancel
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Subtask Modal -->
  <div class="modal" :class="showSubtaskModal ? 'active' : ''" @click.self="showSubtaskModal = false">
    <div class="modal-content glass-effect rounded-2xl p-6 max-w-md">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100">
          <i class="fas fa-plus-circle text-teal-500 mr-2"></i>
          Add Subtask
        </h2>
        <button @click="showSubtaskModal = false" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
          <i class="fas fa-times text-2xl"></i>
        </button>
      </div>
      
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Title *</label>
          <input x-model="newSubtask.title" placeholder="Subtask title" 
                 class="w-full border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 rounded-lg p-3 focus:outline-none focus:ring-2 focus:ring-primary-400 transition-all duration-300">
        </div>
        
        <div class="flex gap-4">
          <button @click="addSubtaskToParent" 
                  class="flex-1 bg-teal-500 hover:bg-teal-600 text-white rounded-lg px-4 py-3 font-semibold transition-all duration-300 hover-lift">
            Add Subtask
          </button>
          <button @click="showSubtaskModal = false" 
                  class="flex-1 bg-gray-500 hover:bg-gray-600 text-white rounded-lg px-4 py-3 font-semibold transition-all duration-300 hover-lift">
            Cancel
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    function todoApp() {
        return {
            todos: [],
            templates: [],
            categories: [],
            stats: {},
            newTodo: {
                title: '',
                description: '',
                priority: 'medium',
                status: 'pending',
                due_date: '',
                estimated_duration: null,
                recurrence_pattern: 'none',
                pomodoro_target: null,
                reminder_datetime: '',
                category_id: null,
                dependency_ids: []
            },
            filters: {
                search: '',
                status: '',
                priority: '',
                category: '',
                sort_by: 'created_at',
                sort_order: 'desc',
                include_archived: false
            },
            selectedTodos: [],
            showStats: true,
            showDashboard: false,
            showAnalytics: false,
            showTemplates: false,
            showCommentsModal: false,
            showActivityModal: false,
            showSuggestionsModal: false,
            showEditModal: false,
            showSubtaskModal: false,
            darkMode: false,
            view: 'list',
            apiUrl: '/todos/',
            debounceTimer: null,
            activeTimer: {
                todo_id: null,
                elapsed_seconds: 0,
                title: '',
                pomodoro_count: 0,
                pomodoro_target: null
            },
            timerInterval: null,
            currentTodoId: null,
            currentComments: [],
            currentActivity: [],
            currentSuggestions: [],
            newComment: '',
            editingTodo: null,
            newSubtask: {
                title: '',
                parent_id: null
            },
            dashboardStats: null,
            dashboardUpcoming: [],
            dashboardActivity: [],
            productivityChart: null,
            categoryChart: null,

            async init() {
                await this.fetchTodos();
                await this.fetchStats();
                await this.fetchTemplates();
                await this.fetchCategories();
                this.loadDarkMode();
                this.startTimerSync();
                setInterval(() => this.fetchStats(), 30000);
            },

            loadDarkMode() {
                const saved = localStorage.getItem('darkMode');
                this.darkMode = saved === 'true';
            },

            async fetchTodos() {
                try {
                    const params = new URLSearchParams();
                    if (this.filters.search) params.append('search', this.filters.search);
                    if (this.filters.status) params.append('status', this.filters.status);
                    if (this.filters.priority) params.append('priority', this.filters.priority);
                    if (this.filters.category) params.append('category', this.filters.category);
                    params.append('sort_by', this.filters.sort_by);
                    params.append('sort_order', this.filters.sort_order);
                    params.append('include_archived', this.filters.include_archived);

                    const res = await fetch(`${this.apiUrl}?${params}`);
                    if (res.ok) {
                        this.todos = await res.json();
                    }
                } catch (error) {
                    console.error('Error fetching todos:', error);
                }
            },

            debouncedFetchTodos() {
                clearTimeout(this.debounceTimer);
                this.debounceTimer = setTimeout(() => this.fetchTodos(), 300);
            },

            async fetchStats() {
                try {
                    const res = await fetch(`${this.apiUrl}stats/`);
                    if (res.ok) {
                        this.stats = await res.json();
                    }
                } catch (error) {
                    console.error('Error fetching stats:', error);
                }
            },

            async fetchTemplates() {
                try {
                    const res = await fetch(`${this.apiUrl}templates/list`);
                    if (res.ok) {
                        this.templates = await res.json();
                    }
                } catch (error) {
                    console.error('Error fetching templates:', error);
                }
            },

            async fetchCategories() {
                try {
                    const res = await fetch(`${this.apiUrl}categories/`);
                    if (res.ok) {
                        this.categories = await res.json();
                    }
                } catch (error) {
                    console.error('Error fetching categories:', error);
                }
            },

            async fetchDashboard() {
                try {
                    const res = await fetch(`${this.apiUrl}dashboard/summary`);
                    if (res.ok) {
                        const data = await res.json();
                        this.dashboardStats = data.stats;
                        this.dashboardUpcoming = data.upcoming_tasks || [];
                        this.dashboardActivity = data.recent_activity || [];
                    }
                } catch (error) {
                    console.error('Error fetching dashboard:', error);
                }
            },

            async addTodo() {
                if (!this.newTodo.title.trim()) return;
                
                try {
                    const todoData = { ...this.newTodo };
                    // Clean up empty values
                    if (!todoData.due_date) delete todoData.due_date;
                    if (!todoData.estimated_duration) delete todoData.estimated_duration;
                    if (!todoData.pomodoro_target) delete todoData.pomodoro_target;
                    if (!todoData.reminder_datetime) delete todoData.reminder_datetime;
                    if (!todoData.category_id) delete todoData.category_id;
                    if (todoData.dependency_ids.length === 0) delete todoData.dependency_ids;

                    const response = await fetch(this.apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(todoData)
                    });

                    if (response.ok) {
                        this.newTodo = {
                            title: '',
                            description: '',
                            priority: 'medium',
                            status: 'pending',
                            due_date: '',
                            estimated_duration: null,
                            recurrence_pattern: 'none',
                            pomodoro_target: null,
                            reminder_datetime: '',
                            category_id: null,
                            dependency_ids: []
                        };
                        
                        await this.fetchTodos();
                        await this.fetchStats();
                        this.showNotification('Task added successfully!', 'success');
                    }
                } catch (error) {
                    console.error('Error adding todo:', error);
                    this.showNotification('Error adding task', 'error');
                }
            },

            async toggleStatus(todo) {
                const newStatus = todo.status === 'completed' ? 'pending' : 'completed';
                
                try {
                    const response = await fetch(`${this.apiUrl}${todo.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status: newStatus })
                    });

                    if (response.ok) {
                        await this.fetchTodos();
                        await this.fetchStats();
                        this.showNotification(newStatus === 'completed' ? 'Task completed!' : 'Task reopened', 'success');
                    }
                } catch (error) {
                    console.error('Error updating todo:', error);
                }
            },

            async toggleSubtaskStatus(subtask) {
                const newStatus = subtask.status === 'completed' ? 'pending' : 'completed';
                
                try {
                    const response = await fetch(`${this.apiUrl}${subtask.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status: newStatus })
                    });

                    if (response.ok) {
                        await this.fetchTodos();
                        this.showNotification('Subtask updated!', 'success');
                    }
                } catch (error) {
                    console.error('Error updating subtask:', error);
                }
            },

            async deleteTodo(id) {
                if (!confirm('Delete this task?')) return;
                
                try {
                    const response = await fetch(`${this.apiUrl}${id}`, { method: 'DELETE' });
                    if (response.ok) {
                        await this.fetchTodos();
                        await this.fetchStats();
                        this.showNotification('Task deleted!', 'success');
                    }
                } catch (error) {
                    console.error('Error deleting todo:', error);
                }
            },

            async editTodo(todo) {
                this.editingTodo = { ...todo };
                this.showEditModal = true;
            },

            async updateTodo() {
                if (!this.editingTodo.title.trim()) return;
                
                try {
                    const response = await fetch(`${this.apiUrl}${this.editingTodo.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(this.editingTodo)
                    });

                    if (response.ok) {
                        this.showEditModal = false;
                        await this.fetchTodos();
                        await this.fetchStats();
                        this.showNotification('Task updated successfully!', 'success');
                    }
                } catch (error) {
                    console.error('Error updating todo:', error);
                    this.showNotification('Error updating task', 'error');
                }
            },

            async toggleArchive(todo) {
                try {
                    const response = await fetch(`${this.apiUrl}${todo.id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ is_archived: !todo.is_archived })
                    });

                    if (response.ok) {
                        await this.fetchTodos();
                        this.showNotification(todo.is_archived ? 'Task unarchived!' : 'Task archived!', 'success');
                    }
                } catch (error) {
                    console.error('Error archiving todo:', error);
                }
            },

            async bulkComplete() {
                if (this.selectedTodos.length === 0) return;
                
                try {
                    const response = await fetch(`${this.apiUrl}bulk/complete`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ todo_ids: this.selectedTodos })
                    });

                    if (response.ok) {
                        this.selectedTodos = [];
                        await this.fetchTodos();
                        await this.fetchStats();
                        this.showNotification('Tasks completed!', 'success');
                    }
                } catch (error) {
                    console.error('Error:', error);
                }
            },

            async bulkArchive() {
                if (this.selectedTodos.length === 0) return;
                
                try {
                    const response = await fetch(`${this.apiUrl}bulk/archive`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ todo_ids: this.selectedTodos })
                    });

                    if (response.ok) {
                        this.selectedTodos = [];
                        await this.fetchTodos();
                        this.showNotification('Tasks archived!', 'success');
                    }
                } catch (error) {
                    console.error('Error:', error);
                }
            },

            async bulkDelete() {
                if (this.selectedTodos.length === 0) return;
                if (!confirm(`Delete ${this.selectedTodos.length} tasks?`)) return;
                
                try {
                    const response = await fetch(`${this.apiUrl}bulk/delete`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ todo_ids: this.selectedTodos })
                    });

                    if (response.ok) {
                        this.selectedTodos = [];
                        await this.fetchTodos();
                        await this.fetchStats();
                        this.showNotification('Tasks deleted!', 'success');
                    }
                } catch (error) {
                    console.error('Error:', error);
                }
            },

            toggleSelection(id) {
                const idx = this.selectedTodos.indexOf(id);
                if (idx > -1) {
                    this.selectedTodos.splice(idx, 1);
                } else {
                    this.selectedTodos.push(id);
                }
            },

            getTodosByStatus(status) {
                return this.todos.filter(todo => todo.status === status);
            },

            // Timer Functions
            async startTimer(todo) {
                try {
                    const response = await fetch(`${this.apiUrl}${todo.id}/timer/start`, {
                        method: 'POST'
                    });

                    if (response.ok) {
                        this.activeTimer = {
                            todo_id: todo.id,
                            elapsed_seconds: 0,
                            title: todo.title,
                            pomodoro_count: todo.pomodoro_count || 0,
                            pomodoro_target: todo.pomodoro_target
                        };
                        this.startTimerInterval();
                        await this.fetchTodos();
                        this.showNotification('Timer started!', 'success');
                    }
                } catch (error) {
                    console.error('Error starting timer:', error);
                }
            },

            async stopTimer(todoId) {
                try {
                    const response = await fetch(`${this.apiUrl}${todoId}/timer/stop`, {
                        method: 'POST'
                    });

                    if (response.ok) {
                        this.activeTimer = {
                            todo_id: null,
                            elapsed_seconds: 0,
                            title: '',
                            pomodoro_count: 0,
                            pomodoro_target: null
                        };
                        this.stopTimerInterval();
                        await this.fetchTodos();
                        await this.fetchStats();
                        this.showNotification('Timer stopped and time logged!', 'success');
                    }
                } catch (error) {
                    console.error('Error stopping timer:', error);
                }
            },

            startTimerInterval() {
                if (this.timerInterval) clearInterval(this.timerInterval);
                
                this.timerInterval = setInterval(() => {
                    this.activeTimer.elapsed_seconds++;
                }, 1000);
            },

            stopTimerInterval() {
                if (this.timerInterval) {
                    clearInterval(this.timerInterval);
                    this.timerInterval = null;
                }
            },

            async startTimerSync() {
                // Check for active timers on page load
                try {
                    const todos = await fetch(`${this.apiUrl}?limit=1000`);
                    if (todos.ok) {
                        const todosData = await todos.json();
                        const activeTimerTodo = todosData.find(t => t.timer_started_at);
                        
                        if (activeTimerTodo) {
                            const startTime = new Date(activeTimerTodo.timer_started_at);
                            const elapsed = Math.floor((new Date() - startTime) / 1000);
                            
                            this.activeTimer = {
                                todo_id: activeTimerTodo.id,
                                elapsed_seconds: elapsed,
                                title: activeTimerTodo.title,
                                pomodoro_count: activeTimerTodo.pomodoro_count || 0,
                                pomodoro_target: activeTimerTodo.pomodoro_target
                            };
                            this.startTimerInterval();
                        }
                    }
                } catch (error) {
                    console.error('Error syncing timer:', error);
                }
            },

            formatTimerDisplay(seconds) {
                const hrs = Math.floor(seconds / 3600);
                const mins = Math.floor((seconds % 3600) / 60);
                const secs = seconds % 60;
                return `${String(hrs).padStart(2, '0')}:${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
            },

            // Pomodoro Functions
            async completePomodoro(todoId) {
                try {
                    const response = await fetch(`${this.apiUrl}${todoId}/pomodoro/complete`, {
                        method: 'POST'
                    });

                    if (response.ok) {
                        this.activeTimer.pomodoro_count++;
                        await this.fetchTodos();
                        await this.fetchStats();
                        this.showNotification('üçÖ Pomodoro completed! Take a break!', 'success');
                    }
                } catch (error) {
                    console.error('Error completing pomodoro:', error);
                }
            },

            // Template Functions
            async makeTemplate(todo) {
                const templateName = prompt('Enter template name:', `${todo.title} Template`);
                if (!templateName) return;
                
                try {
                    const response = await fetch(`${this.apiUrl}${todo.id}/make-template?template_name=${encodeURIComponent(templateName)}`, {
                        method: 'POST'
                    });

                    if (response.ok) {
                        await this.fetchTemplates();
                        this.showNotification('Template created!', 'success');
                    }
                } catch (error) {
                    console.error('Error creating template:', error);
                }
            },

            async createFromTemplate(templateId) {
                try {
                    const response = await fetch(`${this.apiUrl}templates/${templateId}/create`, {
                        method: 'POST'
                    });

                    if (response.ok) {
                        await this.fetchTodos();
                        await this.fetchStats();
                        this.showTemplates = false;
                        this.showNotification('Task created from template!', 'success');
                    }
                } catch (error) {
                    console.error('Error creating from template:', error);
                }
            },

            // Recurring Tasks
            async createNextRecurringInstance(todo) {
                try {
                    const response = await fetch(`${this.apiUrl}${todo.id}/recurring/create-next`, {
                        method: 'POST'
                    });

                    if (response.ok) {
                        await this.fetchTodos();
                        this.showNotification('Next recurring instance created!', 'success');
                    }
                } catch (error) {
                    console.error('Error creating recurring instance:', error);
                }
            },

            // Subtasks
            async addSubtask(parentTodo) {
                this.newSubtask.parent_id = parentTodo.id;
                this.showSubtaskModal = true;
            },

            async addSubtaskToParent() {
                if (!this.newSubtask.title.trim()) return;
                
                try {
                    const subtaskData = {
                        ...this.newSubtask,
                        parent_id: this.newSubtask.parent_id
                    };

                    const response = await fetch(this.apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(subtaskData)
                    });

                    if (response.ok) {
                        this.newSubtask = {
                            title: '',
                            parent_id: null
                        };
                        this.showSubtaskModal = false;
                        await this.fetchTodos();
                        this.showNotification('Subtask added!', 'success');
                    }
                } catch (error) {
                    console.error('Error adding subtask:', error);
                }
            },

            // Comments Functions
            async openComments(todo) {
                this.currentTodoId = todo.id;
                this.showCommentsModal = true;
                
                try {
                    const response = await fetch(`${this.apiUrl}${todo.id}/comments/`);
                    if (response.ok) {
                        this.currentComments = await response.json();
                    }
                } catch (error) {
                    console.error('Error fetching comments:', error);
                }
            },

            async addComment() {
                if (!this.newComment.trim()) return;
                
                try {
                    const response = await fetch(`${this.apiUrl}comments/`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            todo_id: this.currentTodoId,
                            content: this.newComment
                        })
                    });

                    if (response.ok) {
                        this.newComment = '';
                        await this.openComments({ id: this.currentTodoId });
                        this.showNotification('Comment added!', 'success');
                    }
                } catch (error) {
                    console.error('Error adding comment:', error);
                }
            },

            // Activity Log Functions
            async openActivityLog(todo) {
                this.showActivityModal = true;
                
                try {
                    const response = await fetch(`${this.apiUrl}${todo.id}/activity/`);
                    if (response.ok) {
                        this.currentActivity = await response.json();
                    }
                } catch (error) {
                    console.error('Error fetching activity:', error);
                }
            },

            // Smart Suggestions
            async getSmartSuggestions(todo) {
                this.showSuggestionsModal = true;
                
                try {
                    const response = await fetch(`${this.apiUrl}${todo.id}/suggestions/`);
                    if (response.ok) {
                        const data = await response.json();
                        this.currentSuggestions = data.suggestions || [];
                    }
                } catch (error) {
                    console.error('Error fetching suggestions:', error);
                }
            },

            // Category Management
            async addCategory() {
                if (!this.newCategory.name.trim()) return;
                
                try {
                    const response = await fetch(`${this.apiUrl}categories/`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            name: this.newCategory.name,
                            color: '#6B7280'
                        })
                    });

                    if (response.ok) {
                        this.newCategory.name = '';
                        await this.fetchCategories();
                        this.showNotification('Category added!', 'success');
                    }
                } catch (error) {
                    console.error('Error adding category:', error);
                }
            },

            async deleteCategory(id) {
                if (!confirm('Delete this category?')) return;
                
                try {
                    // Note: This would need a DELETE endpoint for categories
                    // For now, we'll just remove it from the UI
                    this.categories = this.categories.filter(c => c.id !== id);
                    this.showNotification('Category removed!', 'success');
                } catch (error) {
                    console.error('Error deleting category:', error);
                }
            },

            // Analytics Functions
            async showAnalyticsModal() {
                this.showAnalytics = true;
                
                // Wait for modal to render
                setTimeout(async () => {
                    try {
                        const response = await fetch(`${this.apiUrl}analytics/productivity-trends/?days=7`);
                        if (response.ok) {
                            const data = await response.json();
                            this.renderProductivityChart(data);
                        }
                        
                        const categoryResponse = await fetch(`${this.apiUrl}analytics/time-by-category/`);
                        if (categoryResponse.ok) {
                            const categoryData = await categoryResponse.json();
                            this.renderCategoryChart(categoryData);
                        }
                    } catch (error) {
                        console.error('Error fetching analytics:', error);
                    }
                }, 100);
            },

            async showDashboardModal() {
                this.showDashboard = true;
                await this.fetchDashboard();
            },

            renderProductivityChart(data) {
                const ctx = document.getElementById('productivityChart');
                if (!ctx) return;
                
                if (this.productivityChart) {
                    this.productivityChart.destroy();
                }
                
                this.productivityChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.labels,
                        datasets: [
                            {
                                label: 'Tasks Completed',
                                data: data.completed,
                                borderColor: 'rgb(34, 197, 94)',
                                backgroundColor: 'rgba(34, 197, 94, 0.1)',
                                tension: 0.4
                            },
                            {
                                label: 'Tasks Created',
                                data: data.created,
                                borderColor: 'rgb(59, 130, 246)',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                tension: 0.4
                            },
                            {
                                label: 'Time Spent (min)',
                                data: data.time_spent,
                                borderColor: 'rgb(168, 85, 247)',
                                backgroundColor: 'rgba(168, 85, 247, 0.1)',
                                tension: 0.4,
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: 'Tasks'
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: 'Minutes'
                                },
                                grid: {
                                    drawOnChartArea: false,
                                }
                            }
                        }
                    }
                });
            },

            renderCategoryChart(data) {
                const ctx = document.getElementById('categoryChart');
                if (!ctx) return;
                
                if (this.categoryChart) {
                    this.categoryChart.destroy();
                }
                
                const labels = Object.keys(data);
                const values = Object.values(data);
                const backgroundColors = [
                    'rgba(255, 99, 132, 0.7)',
                    'rgba(54, 162, 235, 0.7)',
                    'rgba(255, 206, 86, 0.7)',
                    'rgba(75, 192, 192, 0.7)',
                    'rgba(153, 102, 255, 0.7)',
                    'rgba(255, 159, 64, 0.7)'
                ];
                
                this.categoryChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: values,
                            backgroundColor: backgroundColors,
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            },

            // Utility Functions
            isOverdue(dueDate) {
                if (!dueDate) return false;
                return new Date(dueDate) < new Date();
            },

            formatDate(dateStr) {
                if (!dateStr) return '';
                const date = new Date(dateStr);
                const now = new Date();
                const diff = date - now;
                const days = Math.ceil(diff / (1000 * 60 * 60 * 24));
                
                if (days < 0) return '‚ö†Ô∏è Overdue';
                if (days === 0) return 'üìÖ Today';
                if (days === 1) return 'üìÖ Tomorrow';
                return `üìÖ ${date.toLocaleDateString()}`;
            },

            formatDateTime(dateStr) {
                if (!dateStr) return '';
                const date = new Date(dateStr);
                return date.toLocaleString();
            },

            showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg text-white max-w-sm transform translate-x-full transition-transform duration-300 ${
                    type === 'success' ? 'bg-green-500' : 
                    type === 'error' ? 'bg-red-500' : 'bg-blue-500'
                }`;
                
                notification.innerHTML = `
                    <div class="flex items-center gap-2">
                        <i class="fas ${
                            type === 'success' ? 'fa-check-circle' : 
                            type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'
                        }"></i>
                        <span>${message}</span>
                    </div>
                `;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.transform = 'translateX(0)';
                }, 100);
                
                setTimeout(() => {
                    notification.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        if (document.body.contains(notification)) {
                            document.body.removeChild(notification);
                        }
                    }, 300);
                }, 3000);
            }
        }
    }

    // Watch for dark mode changes
    document.addEventListener('alpine:init', () => {
        Alpine.effect(() => {
            const app = Alpine.store || {};
            if (app.darkMode !== undefined) {
                localStorage.setItem('darkMode', app.darkMode);
            }
        });
    });
  </script>
</body>
</html>